@page "/events"

<PageTitle>Клубы и мероприятия</PageTitle>

<MudStack Style="min-width:300px; max-width:750px" Class="ml-3">
    
    <MudStack Row Spacing="0" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-5">
        <MudText Typo="Typo.h6" Class="mr-2">Клубы и мероприятия</MudText>
        @if (CurrentState.Account != null) 
        {
            <MudButton Href="/events/add" StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" title="Добавить мероприятие">
                <MudText Typo="Typo.body2">Добавить</MudText>
            </MudButton>
        }
    </MudStack>

    @* Фильтры запроса *@
    <MudGrid Style="min-width:300px" Class="mb-4">
        <MudItem xs="12">
            <MudTextField Placeholder="Поиск" T="string" ValueChanged="@(s => OnSearch(s))" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Clearable/>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudSelect Placeholder="Все услуги" @bind-SelectedValues="selectedFeatures" T="FeaturesForEventsViewDto" Dense AnchorOrigin="Origin.BottomCenter" Adornment="Adornment.End" IconSize="Size.Medium" MultiSelection Clearable>
                @foreach (var feature in FeaturesList)
                {
                    <MudSelectItem Value="feature">@feature.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudSelect Placeholder="Все организаторы" @bind-SelectedValues="selectedAdmins" T="AdminsForEventsViewDto" Dense AnchorOrigin="Origin.BottomCenter" Adornment="Adornment.End" IconSize="Size.Medium" MultiSelection Clearable>
                @foreach (var admin in AdminsList)
                {
                    <MudSelectItem Value="admin">@admin.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudSelect Placeholder="Все регионы" @bind-SelectedValues="selectedRegions" T="RegionsForEventsViewDto" Dense AnchorOrigin="Origin.BottomCenter" Adornment="Adornment.End" IconSize="Size.Medium" MultiSelection Clearable>
                @if (RegionsList != null) 
                {
                    @foreach (var region in RegionsList)
                    {
                        <MudSelectItem Value="region">@region.Name</MudSelectItem>
                    }
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" Style="padding-top:10px">
            <MudStack Spacing="0" AlignItems="AlignItems.End">
                <MudSwitch Size="Size.Small" @bind-Value="isActualEvents" Label="@actualEventsLabel" Color="Color.Primary" />
            </MudStack>
        </MudItem>

    </MudGrid>


    @* Список мероприятий *@
    <MudDataGrid @ref="dataGrid" Elevation="0" Virtualize Hover T="SchedulesForEventsViewDto" ServerData="ServerReload" Loading="false" Style="min-width:300px; max-width:800px" HeaderClass="dataGridHideTHead" Filterable="false">
        <Columns>
            <TemplateColumn CellClass="py-6">
                <CellTemplate>
                    @if (context.Item.Event != null)
                    {
                    <MudStack Wrap="Wrap.Wrap" Row AlignItems="AlignItems.Center" StretchItems="StretchItems.Middle">

                        <ImageEvent Event="context.Item.Event" Size="EnumImageSize.s150x150" Title="@context.Item.Event.Name" Style="border-radius:5%; width:135px; height:135px; margin-right:8px" />

                        <MudStack Spacing="1">
                            <MudStack Row>
                                <MudButton OnClick="() => ShowDialogs.EventCardDialogAsync(context.Item)" Size="Size.Medium" Color="Color.Primary" Variant="Variant.Text" Class="px-1 py-1">
                                    <MudText Typo="Typo.body1"><b>@context.Item.Event.Name</b></MudText>
                                </MudButton>
                                @if (CurrentState.Account?.Id == context.Item.Event.Admin?.Id) 
                                {
                                    <MudIconButton Href="@($"/events/update/{context.Item.EventId}")" Style="opacity:.4" Icon="@Icons.Material.Outlined.Edit" title="Редактировать" Color="Color.Primary" Size="Size.Small" />
                                }
                            </MudStack>
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Outlined.LocationOn" Style="font-size:20px" />
                                <MudText Typo="Typo.body2">@context.Item.Event.ToRegionString()</MudText>
                            </MudStack>

                            <MudStack Row Spacing="0" AlignItems="AlignItems.Center">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="0" Title="Дата и время начала">
                                    <MudIcon Icon="@Icons.Material.Outlined.CalendarToday" Class="@context.Item.ToDateClass()" Style="font-size:17px;margin-left:1px" />
                                    <MudText Typo="Typo.body2" Class="ml-1" Style="margin-top:2px">@context.Item.StartDate.ToMyString()</MudText>
                                </MudStack>
                                @if (context.Item.NumberOfDiscussions > 0)
                                {
                                    <MudStack Row AlignItems="AlignItems.Center" Spacing="0" Title="@("Обсуждений: " + context.Item.NumberOfDiscussions.ToString())">
                                        <MudIcon Icon="@Icons.Material.Outlined.Chat" Color="Color.Info" Class="ml-4 mr-1" Style="font-size:18px" />
                                        <MudText Typo="Typo.body2" Style="margin-top:1px">@context.Item.NumberOfDiscussions</MudText>
                                    </MudStack>
                                }
                            </MudStack>

                            <MudStack Row Spacing="0">
                                <MudStack Row Spacing="0" Style="margin-left:1px" AlignItems="AlignItems.Center" Class="mr-3" title="Кол-во пар">
                                    <MudIcon Icon="@Icons.Material.Filled.PeopleAlt" Color="Color.Tertiary" Style="font-size:17px" Class="mr-1" />
                                    <MudText Typo="Typo.body2">@context.Item.NumberOfRegisteredPairs()</MudText>
                                </MudStack>
                                <MudStack Row Spacing="0" AlignItems="AlignItems.Center" Class="mr-3" title="Кол-во мужчин">
                                    <MudIcon Icon="@Icons.Material.Outlined.Face5" Color="Color.Primary" Style="font-size:16px" Class="mr-1" />
                                    <MudText Typo="Typo.body2">@context.Item.NumberOfRegisteredMen()</MudText>
                                </MudStack>
                                <MudStack Row Spacing="0" AlignItems="AlignItems.Center" Class="mr-3" title="Кол-во женщин">
                                    <MudIcon Icon="@Icons.Material.Outlined.Face3" Color="Color.Error" Style="font-size:15px" Class="mr-1" />
                                    <MudText Typo="Typo.body2">@context.Item.NumberOfRegisteredWomen()</MudText>
                                </MudStack>
                                <MudStack Row Spacing="0">
                                    <MudText Typo="Typo.body2" Class="ml-2" title="Средний возраст гостей">@context.Item.AverageAgeOfRegistered()</MudText>
                                </MudStack>
                            </MudStack>
                            @if (context.Item.Features != null)
                            {
                                <MudStack Row Wrap="Wrap.Wrap" Spacing="1" Class="mt-1 mb-2">
                                    @foreach (var feature in context.Item.Features.OrderBy(o => o.Name))
                                    {
                                            <span style="padding: 0 5px 0 5px; font-size:12px; font-weight:500; opacity:0.6; border-width: 1px; border-style: dotted">@feature.Name</span>
                                    }
                                </MudStack>
                            }
                        </MudStack>

                        <MudStack AlignItems="AlignItems.Center" Spacing="2" Style="width:100px">
                            <MudButton OnClick="() => ShowDialogs.AccountCardDialogAsync(context.Item.Event.Admin!)">
                                <MudStack AlignItems="AlignItems.Center">
                                    <ImageAvatar Account="context.Item.Event.Admin" Size="EnumImageSize.s64x64" Title="Организатор" class="s45" Style="border-radius:50%" />
                                    <ColorizedAccountName Account="@context.Item.Event.Admin" Typo="Typo.body2" Style="font-size:12px; text-align:center" />
                                </MudStack>
                            </MudButton>
                        </MudStack>

                    </MudStack>
                    }
                </CellTemplate>
            </TemplateColumn>
        </Columns>

        <PagerContent>
            <MudDataGridPager RowsPerPageString="Показывать по:" ShowPageNumber="false" T="SchedulesForEventsViewDto" />
        </PagerContent>
    </MudDataGrid>

</MudStack>