@inject DialogService DialogService

@page "/register"
<PageTitle>Регистрация</PageTitle>

<RadzenCard Variant="Variant.Filled" Class="rz-my-6 rz-mx-auto" Style="max-width: 750px">

    <RadzenText TextAlign="TextAlign.Center" TextStyle="TextStyle.H6">Регистрация</RadzenText>

    <RadzenSteps NextText="Далее" NextTitle="К следующему шагу" PreviousText="Назад" PreviousTitle="К предыдущему шагу">
        <Steps>
            @* Шаг первый - общее *@
            <RadzenStepsItem Text="Общее">
                <RadzenStack Orientation="Orientation.Vertical" Gap="0">
                    <RadzenText TextStyle="TextStyle.Subtitle2"><b>Имя Вашей учётной записи</b></RadzenText>
                    <RadzenTextBox @bind-Value=@RegisterModel.Name MaxLength="40" Style="width: 100%" />
                    <hr />
                    <RadzenText TextStyle="TextStyle.Subtitle2"><b>Адрес электронной почты</b></RadzenText>
                    <RadzenTextBox @bind-Value=@RegisterModel.Email MaxLength="75" Style="width: 100%" />
                    <hr />

                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="12" SizeSM="6">
                            <RadzenStack Orientation="Orientation.Vertical" Gap="0">
                                <RadzenText TextStyle="TextStyle.Subtitle2"><b>Пароль</b></RadzenText>
                                <RadzenPassword @bind-Value=@RegisterModel.Password MaxLength="35" />
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6">
                            <RadzenStack Orientation="Orientation.Vertical" Gap="0">
                                <RadzenText TextStyle="TextStyle.Subtitle2"><b>Повтор пароля</b></RadzenText>
                                <RadzenPassword @bind-Value=@RegisterModel.Password2 MaxLength="35" />
                            </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>

                    <hr />

                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="12" SizeSM="6">
                            <RadzenStack Orientation="Orientation.Vertical" Gap="0">
                                <RadzenText TextStyle="TextStyle.Subtitle2"><b>Страна</b></RadzenText>
                                <RadzenDropDown @bind-Value=@countryId Data=@countries ValueProperty="@nameof(CountriesViewDto.Id)" TextProperty="@nameof(CountriesViewDto.Name)" Name="DropDownCountries" />
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6">
                            <RadzenStack Orientation="Orientation.Vertical" Gap="0">
                                <RadzenText TextStyle="TextStyle.Subtitle2"><b>Город</b></RadzenText>
                                <RadzenDropDown @bind-Value=@regionId Data=@regions ValueProperty="@nameof(RegionsDto.Id)" TextProperty="@nameof(RegionsDto.Name)" Name="DropDownRegions" />
                            </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>

                </RadzenStack>
            </RadzenStepsItem>

            @* Шаг второй - аватар *@
            <RadzenStepsItem Text="Аватар">
                <RadzenStack AlignItems="AlignItems.Center">
                    <RadzenCard Style="width: 100%; max-width: 600px;">
                        <RadzenText TextStyle="TextStyle.H6" TextAlign="TextAlign.Center"><strong>@RegisterModel.Name</strong></RadzenText>
                        <RadzenFileInput
                            @bind-Value=@RegisterModel.Photo
                            @bind-FileName=@fileName 
                            @bind-FileSize=@fileSize
                            TValue="string"
                            Style="width: 100%; text-align: center"
                            ChooseText="Выберите фото для аватара"
                            Change=@(args => OnChange(args, "FileInput")) Error=@(args => OnError(args, "FileInput")) InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "select file" }})" />
                    </RadzenCard>
                </RadzenStack>
            </RadzenStepsItem>

            @* Шаг третий - партнёры *@
            <RadzenStepsItem Text="Партнёры">

                <RadzenDataGrid @ref="usersGrid" AllowAlternatingRows="false" AllowFiltering="false" AllowPaging="false" AllowSorting="false" EditMode="DataGridEditMode.Single"
                                Data="@RegisterModel.Users" TItem="UsersDto" EmptyText="Добавьте от 1 до 4 партнёров..."
                                ColumnWidth="100px">
                    <Columns>
                        <RadzenDataGridColumn Property="@nameof(UsersDto.Name)" Title="Имя" />

                        <RadzenDataGridColumn Property="GenderAge" Title="Возраст">
                            <Template Context="user">
                                <RadzenText>@user.ToGenderAgeString()</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn Context="user" Width="40px" Filterable="false" Sortable="false" TextAlign="TextAlign.Center" Frozen="true" FrozenPosition="FrozenColumnPosition.Right">
                            <Template Context="user">
                                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" @onclick:stopPropagation="true" />
                                <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat" Shade="Shade.Lighter" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" @onclick:stopPropagation="true" />
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>

                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Right" class="rz-mt-3">
                    <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="add_circle" Text="Добавить" Click=@(() => OpenEditUserForm(null)) />
                </RadzenStack>
            </RadzenStepsItem>


            @* Шаг четвёртый - Финиш *@
            <RadzenStepsItem Text="Финиш">
                <hr />
                <RadzenStack Orientation="Orientation.Vertical" Gap="0">
                    <RadzenButton Text="Зарегистрироваться" />
                </RadzenStack>
            </RadzenStepsItem>

        </Steps>
    </RadzenSteps>

</RadzenCard>

@code {
    // ШАГ 1
    int countryId
    {
        get { return RegisterModel.Country.Id; }
        set
        {
            RegisterModel.Country.Id = value;
            regions = countries?
                .Where(x => x.Id == countryId).FirstOrDefault()?
                .Regions?.Select(s => s).ToList();
        }
    }

    int regionId
    {
        get { return RegisterModel.Country.Region.Id; }
        set { RegisterModel.Country.Region.Id = value; }
    }


    // ШАГ 2
    string? fileName;
    long? fileSize;
    string? photo;

    void OnChange(string value, string name)
    {
        fileName = "Ваш аватар";
        fileSize = null;

        //value = Regex.Replace(value, @"^data:image\/[a-zA-Z]+;base64,", string.Empty);
        //var base64 = Convert.FromBase64String(value);
        //using (MemoryStream output = new MemoryStream(500000))
        //    await File.WriteAllBytesAsync($"c:\\test.jpg", base64);
    }

    void OnError(UploadErrorEventArgs args, string name) { }


    // ШАГ 3
    RadzenDataGrid<UsersDto> usersGrid = null!;

    async Task DeleteRow(UsersDto user)
    {
        if (RegisterModel.Users.Contains(user))
        {
            RegisterModel.Users.Remove(user);
            await usersGrid.Reload();
        }
        else
        {
            usersGrid.CancelEditRow(user);
            await usersGrid.Reload();
        }
    }
}