@inject DialogService DialogService
@inject IConfiguration _config

@page "/register"
<PageTitle>Регистрация</PageTitle>

<RadzenCard Variant="Variant.Filled" Class="rz-my-6 rz-mx-auto" Style="max-width: 750px">

    @if (!string.IsNullOrWhiteSpace(RegisterModel.Name))
    {
        <RadzenText TextAlign="TextAlign.Center" TextStyle="TextStyle.H5">@RegisterModel.Name</RadzenText>
    }

    <RadzenText TextAlign="TextAlign.Center" TextStyle="TextStyle.H6">Регистрация</RadzenText>

    <RadzenSteps CanChange="CanChange" NextText="Далее" NextTitle="К следующему шагу" PreviousText="Назад" PreviousTitle="К предыдущему шагу">
        <Steps>
            
            @* ШАГ 1 - ОБЩЕЕ *@
            <RadzenStepsItem Text="Общее">
                <RadzenStack Orientation="Orientation.Vertical" Gap="0">
                    <RadzenText TextStyle="TextStyle.Subtitle2"><b>Имя Вашей учётной записи</b></RadzenText>
                    <RadzenTextBox @bind-Value=@RegisterModel.Name MaxLength="40" Style="width: 100%" />
                    <hr />
                    <RadzenText TextStyle="TextStyle.Subtitle2"><b>Адрес электронной почты</b></RadzenText>
                    <RadzenTextBox @bind-Value=@RegisterModel.Email MaxLength="75" Style="width: 100%" />
                    <hr />

                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="12" SizeSM="6">
                            <RadzenStack Orientation="Orientation.Vertical" Gap="0">
                                <RadzenText TextStyle="TextStyle.Subtitle2"><b>Пароль</b></RadzenText>
                                <RadzenPassword @bind-Value=@RegisterModel.Password MaxLength="35" />
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6">
                            <RadzenStack Orientation="Orientation.Vertical" Gap="0">
                                <RadzenText TextStyle="TextStyle.Subtitle2"><b>Повтор пароля</b></RadzenText>
                                <RadzenPassword @bind-Value=@RegisterModel.Password2 MaxLength="35" />
                            </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>

                    <hr />

                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="12" SizeSM="6">
                            <RadzenStack Orientation="Orientation.Vertical" Gap="0">
                                <RadzenText TextStyle="TextStyle.Subtitle2"><b>Страна</b></RadzenText>
                                <RadzenDropDown @bind-Value=@countryId Data=@countries ValueProperty="@nameof(CountriesViewDto.Id)" TextProperty="@nameof(CountriesViewDto.Name)" Name="DropDownCountries" />
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6">
                            <RadzenStack Orientation="Orientation.Vertical" Gap="0">
                                <RadzenText TextStyle="TextStyle.Subtitle2"><b>Город</b></RadzenText>
                                <RadzenDropDown @bind-Value=@regionId Data=@regions ValueProperty="@nameof(RegionsDto.Id)" TextProperty="@nameof(RegionsDto.Name)" Name="DropDownRegions" />
                            </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>

                </RadzenStack>
            </RadzenStepsItem>

            @* ШАГ 2 - АВАТАР *@
            <RadzenStepsItem Text="Аватар">
                <RadzenStack AlignItems="AlignItems.Center">
                    <RadzenCard Style="width: 100%; max-width: 600px; text-align: center">

                        @if (RegisterModel.PreviewPhoto != null)
                        {
                            <img src="/images/AccountsPhotos/temp/@(RegisterModel.PreviewPhoto)" style="width: 150px; height: 150px" />
                        }

                        <RadzenUpload Url=@(_config.GetRequiredSection("WebAPI:Host").Value + "/Photos/UploadTemp")
                            Progress=@OnProgress
                            Complete=@OnComplete
                            Error=@OnError
                            Accept=".jpg;.jpeg;.png"
                            ChooseText="Выберите фото для аватара"
                            Style="width: 100%; text-align: center" InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "select file" }})" />
                        
                        @if (!string.IsNullOrEmpty(RegisterModel.ErrorUploadMessage))
                        {
                            <RadzenText class="rz-color-danger">@RegisterModel.ErrorUploadMessage</RadzenText>
                        }

                        <RadzenProgressBar Value=@progressUpload class="rz-mt-6" Visible=true />
                        
                    </RadzenCard>
                </RadzenStack>
            </RadzenStepsItem>

            @* ШАГ 3 - ПАРТНЁРЫ *@
            <RadzenStepsItem Text="Партнёры">

                <RadzenDataGrid @ref="usersGrid" AllowAlternatingRows="false" AllowFiltering="false" AllowPaging="false" AllowSorting="false" EditMode="DataGridEditMode.Single"
                                Data="@RegisterModel.Users" TItem="UsersDto" EmptyText="Добавьте от 1 до 4 партнёров..."
                                ColumnWidth="100px">
                    <Columns>
                        <RadzenDataGridColumn Property="@nameof(UsersDto.Name)" Title="Имя" />

                        <RadzenDataGridColumn Property="GenderAge" Title="Возраст">
                            <Template Context="user">
                                <RadzenText>@user.ToGenderAgeString()</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn Context="user" Width="37px" Filterable="false" Sortable="false" TextAlign="TextAlign.Center" Frozen="true" FrozenPosition="FrozenColumnPosition.Right">
                            <Template Context="user">
                                <RadzenButton Click=@(() => OpenEditUserForm(user)) Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" @onclick:stopPropagation="true" />
                                <RadzenButton Click="@(args => DeleteRow(user))" ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat" Shade="Shade.Lighter" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" @onclick:stopPropagation="true" />
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>

                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Right" class="rz-mt-3">
                    <RadzenButton ButtonStyle="ButtonStyle.Secondary" Disabled="IsNewUserButtonDisabled" Size="ButtonSize.Small" Icon="add_circle" Text="Добавить" Click=@(() => OpenEditUserForm(null)) />
                </RadzenStack>

                <hr />
                <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="0">
                    @if (!string.IsNullOrEmpty(RegisterModel.ErrorRegisterMessage))
                    {
                        <RadzenText TextAlign="TextAlign.Center" class="rz-color-danger rz-mb-2">@RegisterModel.ErrorRegisterMessage</RadzenText>
                    }
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10" class="rz-my-4">
                        <RadzenCheckBox @bind-Value="RegisterModel.RememberMe" />
                        <RadzenLabel Text="Запомнить меня" />
                    </RadzenStack>
                    <RadzenButton Click="RegistrationAsync" ButtonStyle="ButtonStyle.Success" Disabled="@IsRegisterButtonDisabled" Size="ButtonSize.Large" Text="Зарегистрироваться" />
                </RadzenStack>
            </RadzenStepsItem>

        </Steps>
    </RadzenSteps>

</RadzenCard>
